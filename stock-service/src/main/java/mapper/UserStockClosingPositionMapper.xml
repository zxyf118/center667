<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.UserStockClosingPositionMapper">
	<select id="managerStockClosingList" resultType="vo.manager.StockClosingPositionListVO">
		SELECT 
		    usp.id,
		    position_type,
		    user_id,
		    stock_name,
		    stock_code,
		    stock_type,
		    stock_plate,
		    a.id agentId,
		    a.agent_name,
		    trading_order_sn,
		    position_time,
		    closing_time,
		    buying_price,
		    position_direction,
		    buying_shares,
		    lever,
		    buying_fee,
		    buying_stamp_duty,
		    selling_price,
		    selling_shares,
		    selling_fee,
		    selling_stamp_duty,
		    spread_fee,
		    floating_profit,
		    actual_profit,
		    position_id,
		    exchange_rate,
		    selling_price*selling_shares as marketValue
		FROM
		    user_stock_closing_position usp
		        INNER JOIN
		    user_info u ON usp.user_id = u.id
		        LEFT JOIN
		    agent_info a ON u.agent_id = a.id
		
		<trim prefix="where" suffixOverrides="and">
			<choose>
				<when test="isBlockTrading == true">
					is_block_trading=1 and
				</when>
				<otherwise>
					is_block_trading=0 and
				</otherwise>
			</choose>
			<if test="param.id != null and param.id > 0">
				usp.position_id=#{param.id} and 
			</if>
			<if test="param.tradingOrderSn != null and param.tradingOrderSn != ''">
				trading_order_sn=#{param.tradingOrderSn} and 
			</if>
			<if test="param.stockCodeOrName != null and param.stockCodeOrName != ''">
				(stock_code like '%${param.stockCodeOrName}%' or stock_name like '%${param.stockCodeOrName}%') and 
			</if>
			<if test="param.agentId != null and param.agentId > 0">
				a.id=#{param.agentId} and 
			</if>
			<if test="param.userId != null and param.userId > 0">
				u.id=#{param.userId} and 
			</if>
	       	<if test="param.stockType != null and param.stockType != ''">
	       		stock_type = #{param.stockType} and 
	       	</if>
	       	<if test="param.stockPlate != null and param.stockPlate != ''">
	       		stock_plate = #{param.stockPlate} and 
	       	</if>
	       	<if test="param.startTime != null">
	       		closing_time >= #{param.startTime} and  
	       	</if>
	       	<if test="param.endTime != null">
	       		closing_time &lt;= #{param.endTime}
	       	</if>
		</trim>    
		order by id desc
	</select>
</mapper>
